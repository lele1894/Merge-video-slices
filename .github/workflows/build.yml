name: 构建可执行文件并发布

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: 配置 Python 环境
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
    
    - name: 安装依赖包
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: 下载 FFmpeg
      run: |
        curl -L https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -o ffmpeg.zip
        7z x ffmpeg.zip
        move ffmpeg-*-essentials_build\bin\ffmpeg.exe .
    
    - name: 构建独立版程序（不含 FFmpeg）
      run: |
        echo "开始构建不含 FFmpeg 的版本..."
        pyinstaller --noconfirm --onefile --windowed `
          --icon=app.ico `
          --add-data "LICENSE;." `
          --add-data "README.md;." `
          --name "video-splitter-no-ffmpeg" `
          "视频切片合并.py"
        echo "构建完成，检查 dist 目录："
        dir dist
    
    - name: 构建独立版程序（含 FFmpeg）
      run: |
        echo "开始构建含 FFmpeg 的版本..."
        pyinstaller --noconfirm --onefile --windowed `
          --icon=app.ico `
          --add-data "LICENSE;." `
          --add-data "README.md;." `
          --add-binary "ffmpeg.exe;." `
          --name "video-splitter-with-ffmpeg" `
          "视频切片合并.py"
        echo "构建完成，检查 dist 目录："
        dir dist
    
    - name: 创建发布版本并上传文件
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "准备创建发布版本..."
        
        # 如果标签已存在，先删除它
        gh release delete ${{ github.event.inputs.version }} --yes || true
        git push --delete origin ${{ github.event.inputs.version }} || true
        
        # 检查并重命名文件
        echo "检查 dist 目录中的文件："
        cd dist
        dir
        
        echo "重命名文件..."
        if (Test-Path "video-splitter-no-ffmpeg.exe") {
            ren "video-splitter-no-ffmpeg.exe" "视频场景分割工具_需要FFmpeg.exe"
            echo "已重命名不含 FFmpeg 的版本"
        } else {
            echo "错误：找不到 video-splitter-no-ffmpeg.exe"
        }
        
        if (Test-Path "video-splitter-with-ffmpeg.exe") {
            ren "video-splitter-with-ffmpeg.exe" "视频场景分割工具_含FFmpeg.exe"
            echo "已重命名含 FFmpeg 的版本"
        } else {
            echo "错误：找不到 video-splitter-with-ffmpeg.exe"
        }
        
        echo "重命名后的文件列表："
        dir
        cd ..
        
        # 创建新的发布版本
        echo "创建发布版本..."
        gh release create ${{ github.event.inputs.version }} --title "发布 ${{ github.event.inputs.version }}" --notes "### 发布说明

        提供两个版本：
        1. 视频场景分割工具_需要FFmpeg.exe：需要自行安装 FFmpeg
        2. 视频场景分割工具_含FFmpeg.exe：已包含 FFmpeg，开箱即用
        
        请根据需要选择合适的版本下载。"

        # 上传文件前再次确认文件存在
        echo "准备上传文件..."
        dir dist
        
        echo "上传不含 FFmpeg 的版本..."
        gh release upload ${{ github.event.inputs.version }} "./dist/视频场景分割工具_需要FFmpeg.exe" --clobber
        
        echo "上传含 FFmpeg 的版本..."
        gh release upload ${{ github.event.inputs.version }} "./dist/视频场景分割工具_含FFmpeg.exe" --clobber